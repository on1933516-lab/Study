# JavaScriptについて
## ■ OutSystemsアプリケーションでJavaScriptツールを使用し独自のJavaScriptを記述する方法

 - JavaScriptツールはフロー要素のため、アクションフロー内に配置する。
   
 - 独自のJavaScriptエディタが用意されている。
   
   ※JavaScriptキーワードと、事前定義されたJavaScriptオブジェクトのオートコンプリートをサポートしている。
     構文チェック機能もある。
   
 - ツールには独自のスコープがあるため、
   アクションフローの他の要素とデータをやり取りするには、
   入力パラメータと出力パラメータを定義する必要がある。
   
 - JavaScript変数や関数の宣言・使用も可能
   
   ※それぞれの定義に用いたJavaScriptツールのコンテキストに限定される。

---

## ■ グローバルスクリプトを使用したモジュール内での再利用可能なロジックの定義方法

 - 再利用可能なJavaScriptロジックを定義する必要がある場合や、
   既存のJavaScriptライブラリを使用する場合は、
   モジュールのScriptsフォルダに随時グローバルJavaScriptファイルを追加することで使用できる

---

## ■ スコープ別の JavaScript 利用まとめ

| スコープ | 役割・特徴 | 利用範囲 |
|---------|-----------|-----------|
| **クライアントアクション** | ・JavaScript のメソッド相当<br>・画面やブロック内のイベントに紐付け可能<br>・フローに JavaScript ツールを配置して実装 | 同一画面またはブロック内のみ |
| **グローバルクライアントアクション** | ・Logic レイヤーに作成する共通アクション<br>・アプリ内の他のクライアントアクションから呼び出し可能 | モジュール内のすべての画面・ブロック |
| **モジュール** | ・モジュール全体を対象に JavaScript ライブラリなどを追加可能<br>・共通処理や外部ライブラリを使うときに適する | モジュール内すべての UI |
| **ブロック** | ・ブロック専用の JavaScript を定義可能<br>・ブロックを使用したすべての画面で共通の動作が可能 | ブロックを配置した全画面 |
| **画面（Screen）** | ・画面単位の JavaScript を設定可能<br>・その画面内部のみで適用される | 対象の画面のみ |

---

## ■ 補足

- **クライアントアクションの JavaScript ツール**  
  フローに追加するノードとして JS を記述し実行する形式。

- **スコープ選択は再利用性と保守性に影響**  
  広く使いたいならモジュール／限定したいなら画面 or ブロックなど、用途に応じて使い分ける。

---

## ■JavaScriptの定義順序

実行時に定義済みのJavaScriptは以下の順序で実行される。
```text
1. モジュールレベルのスクリプト
2. ブロックレベルのスクリプト
3. 画面レベルのスクリプト
```

※検証時は、各スクリプト内にコンソールログを配置し、
　検証ツールを使用してブラウザでコンソールログを確認する

---

## ■ クライアントアクション内での JavaScript の実行

クライアントアクションの JavaScript は **明示的に呼び出さない限り実行されない**。

### ● 呼び出し例

- **画面クライアントアクション**  
  → 画面上の `OnClick` などのイベントで実行できる。

- **グローバルクライアントアクション**  
  → 他の画面クライアントアクションから呼び出すことができる。

- **JavaScript ノード経由で関数を呼び出す**  
  → 事前に定義した関数を、モジュール / ブロック / 画面 からオンデマンドで実行可能。

---

## ■ JavaScript ノードの概要

OutSystems の Service Studio では、アクションフロー内で JavaScript を実行する **JavaScript ノード** が利用できる。

### ● ノードの使い方

- Service Studio の **Toolbox > Logic > JavaScript** に存在する
- フローにドラッグ＆ドロップして使用
- ノードの “JavaScript” プロパティをダブルクリックするとコードエディタが開く  
  → ここで通常の JavaScript を記述可能  
    - 変数宣言  
    - 値の代入  
    - ユーザー定義関数の呼び出し  
    - ビルトイン関数の利用  

---

# JavaScript ノードで使用できる特殊キーワード（OutSystems Reactive）

OutSystems の JavaScript ノードでは、いくつかの特別なオブジェクト／キーワードが自動的に提供される。  
これらを使うことで、クライアントアクション呼び出し、画面情報取得、API 利用などが可能になる。

---

## ■ $parameters  
JavaScript ノードの **入力・出力パラメータにアクセスするためのオブジェクト**。

- 通常の JavaScript 変数のように扱える  
- ノードに設定した input/output パラメータへアクセス可能  
- 例：`$parameters.MyInput`, `$parameters.MyOutput = value`

---

## ■ $actions  
現在のスコープ内でアクセス可能な **クライアント側アクションを JavaScript から呼び出せる**。

### 特徴
- クライアントアクションを **同期 / 非同期** いずれでも実行可能  
- 画面アクションフローにある JavaScript ノードからは、その画面で定義されている  
  **画面アクション（Screen Actions）** も呼び出せる  
- 戻り値は、呼び出したアクションの **出力パラメータを格納したシンプルな JS オブジェクト**

### 例
```js
const result = await $actions.MyClientAction({ input: 123 });
console.log(result.outputParameter);
```

※ 参照しているモジュールの Public なクライアントアクションも $actions から呼び出し可能。

## ■ $public

OutSystems が提供する パブリック JavaScript API へアクセスするためのオブジェクト。

利用できる主な API：

 - ApplicationLifecycle

   アプリの読み込みイベントやアップグレードイベントに対して
   JavaScript ハンドラを登録し、進捗や状態を制御できる。


 - Device

   モバイルアプリから 安全にデバイス機能へアクセスするための API。


 - FeedbackMessage

   JavaScript から フィードバックメッセージ（成功・警告・エラーなど） を表示／非表示にできる。


 - Logger

   コンソールや Service Center に対してログ出力（info / warn / error） を行うためのメソッドを提供する。


 - Security

   クライアント側で ロール確認（Role Check） が可能。
   ブラウザにキャッシュされた情報が使われるため、セキュリティ実装ではなく UX 向上目的にのみ使用すること。


 - View

   アクティブなビューコンポーネントとその状態にアクセスできる。
   画面変更や遷移処理に役立つ。


 - Navigation

   ナビゲーション履歴の確認、画面遷移、戻る動作のカスタマイズが可能。


 - Validation

   ウィジェットのバリデーション状態を取得・変更できる。
   特に リピーター内で通常の手法が使えない場面 に便利。


 - ApplicationContext

   現在の画面が属する モジュールやアプリケーションの情報を取得できる。

その他の API については OutSystems 公式オンラインヘルプを参照。


## ■ $roles

現在のモジュールで定義されている すべてのカスタムロールにアクセスできる。

$public.Security と組み合わせると、
クライアント側のみでロール判定を行うことが可能（※キャッシュ情報に基づく）

Anonymous / Registered などのビルトインロールには アクセス不可。<br>
判定したいときは<br>
→ $public.Security.isUserRegistered()<br>
→ $public.Security.isUserAnonymous()<br>
などを使う。

※ $roles は「ロール名の定義」であり、ユーザーがそのロールを持つかどうかの判定には利用できない。

---
